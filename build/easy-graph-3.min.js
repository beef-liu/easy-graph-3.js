EG3={REVISION:"1"};(function(){if(!Array.prototype.forEach){Array.prototype.forEach=function(callBack,thisArg){if(!this){throw new TypeError("this is undefined")}if(!callBack){throw new TypeError("callBack is undefined")}var obj=Object(this);var len=obj.length>>>0;if(typeof callBack!="function"){throw new TypeError(callBack+" is not a function")}var T;if(thisArg){T=thisArg}var i=0;while(i<len){var e;if(i in obj){e=obj[i];callBack.call(T,e,i,obj)}i++}}}}());EG3.Map=function(){var _indexMap={};var _entryArray=[];var _size=0;this.del=function(key){var index=_indexMap[key];if(index!=undefined){delete _indexMap[key];delete _entryArray[index];_size--;return true}else{return false}};this.clear=function(){delete _indexMap;_indexMap={};delete _entryArray;_entryArray=[];_size=0};this.size=function(){return _size};this.set=function(key,value){if(key==undefined){throw new TypeError("key is undefined")}var index=_indexMap[key];if(index==undefined){_indexMap[key]=_entryArray.length;_entryArray.push({key:key,value:value});_size++;return true}else{_entryArray[index].value=value;return false}};this.add=function(obj){var cnt=0;for(var key in obj){if(this.set(key,obj[key])){cnt++}}return cnt};this.get=function(key){var index=_indexMap[key];if(index==undefined){return null}else{return _entryArray[index].value}};this.sort=function(sortby){if(sortby){_entryArray.sort(sortby);rebuildIndexMap()}else{this.sortByKey()}};this.sortByKey=function(isAsc){var asc=true;if(isAsc!=undefined){asc=isAsc}_entryArray.sort(function(v1,v2){if(v1.key==v2.key){return 0}else{if((v1.key<v2.key)==asc){return -1}else{return 1}}});rebuildIndexMap()};this.sortByValue=function(isAsc){var asc=true;if(isAsc!=undefined){asc=isAsc}_entryArray.sort(function(v1,v2){if(v1.value==v2.value){return 0}else{if((v1.value<v2.value)==asc){return -1}else{return 1}}});rebuildIndexMap()};function rebuildIndexMap(){var entry;for(var i=0;i<_entryArray.length;i++){entry=_entryArray[i];_indexMap[entry.key]=i}}this.forEach=function(callBack,thisArg){var T;if(thisArg){T=thisArg}for(var i=0;i<_entryArray.length;i++){if(_entryArray[i]!=undefined){callBack.call(T,_entryArray[i],i,this)}}}};EG3.Map.prototype={log:function(msg){if(msg){console.log("EG3.Map "+msg+" -----")}else{console.log("EG3.Map -----")}this.forEach(function(v){console.log(v)})}};EG3.GraphNode=function(vid,vtype){this.vid=null;if(vid!=undefined){this.vid=vid}this.vtype=null;if(vtype!=undefined){this.vtype=vtype}this.parents=[];this.children=[]};EG3.GridPositionDistribution=function(gridWidth){this.gridWidth=100;if(gridWidth!=undefined){this.gridWidth=gridWidth}var _gridWidth=this.gridWidth;var _gridCellCount,_roundEndPos;var _curRoundGrids=[];this.reset=function(){_gridCellCount=0;_curRoundGrids.splice(0,_curRoundGrids.length);_curRoundGrids.push({x:0,y:0,z:0});_roundEndPos={x:0,y:0,z:0}};this.reset();this.nextPosition=function(){var x,y,z;if(_curRoundGrids.length==0){_gridCellCount+=2;createRoundPositions(_gridCellCount,this.gridWidth)}var randIndex=Math.min(Math.max(Math.floor(Math.random()*_curRoundGrids.length),_curRoundGrids.length-1),0);var pos=_curRoundGrids.splice(randIndex,1)[0];return pos};function createRoundPositions(d,step){var x=_roundEndPos.x;var y=_roundEndPos.y;var z=_roundEndPos.z;x+=step;y-=step;_curRoundGrids.push({x:x,y:y,z:z});_roundEndPos.x=x;_roundEndPos.y=y;_roundEndPos.z=z;var i;for(i=1;i<=d;i++){y+=step;_curRoundGrids.push({x:x,y:y,z:z})}for(i=1;i<=d;i++){x-=step;_curRoundGrids.push({x:x,y:y,z:z})}for(i=1;i<=d;i++){y-=step;_curRoundGrids.push({x:x,y:y,z:z})}for(i=1;i<=d;i++){x+=step;if(i!=d){_curRoundGrids.push({x:x,y:y,z:z})}}}};EG3.SpherePositionDistribution=function(originPoint,direction,maxCount,space,fov){var FloorPI=3;this.fov=90;if(fov!=undefined){this.fov=fov}this.originPoint=originPoint;this.direction=direction;this.maxCount=maxCount;this.space=space;var _fovRad=Math.PI*(this.fov/180);var _vector3Tmp=new THREE.Vector3(0,0,0);var _roundIndex;var _curRoundPositions=[];var _quaternionForRotate=new THREE.Quaternion();this.radius=null;this.axisUnitVector=null;this.axisEndPoint=null;this.reset=function(){this.radius=calcuRadius(maxCount,this.space,_fovRad);var axisVectorLength=Math.pow(this.direction.x*this.direction.x+this.direction.y*this.direction.y+this.direction.z*this.direction.z,0.5);this.axisUnitVector=new THREE.Vector3(this.direction.x/axisVectorLength,this.direction.y/axisVectorLength,this.direction.z/axisVectorLength);this.axisEndPoint={x:originPoint.x+this.radius*this.axisUnitVector.x,y:originPoint.y+this.radius*this.axisUnitVector.y,z:originPoint.z+this.radius*this.axisUnitVector.z};var vZ=new THREE.Vector3(0,0,1);var angle=0;if(!this.axisUnitVector.equals(vZ)){var triangle=new THREE.Triangle(new THREE.Vector3(0,0,0),vZ,this.axisUnitVector);var vNormal=triangle.normal();angle=Math.acos(vZ.dot(this.axisUnitVector));_quaternionForRotate.setFromAxisAngle(vNormal,angle)}else{_quaternionForRotate=null}_roundIndex=0;_curRoundPositions.splice(0,_curRoundPositions.length);_curRoundPositions.push({x:this.axisEndPoint.x,y:this.axisEndPoint.y,z:this.axisEndPoint.z})};this.reset();this.nextPosition=function(){var x,y,z;if(_curRoundPositions.length==0){_roundIndex++;var roundPointCount=2*FloorPI*_roundIndex;createRoundPositions(this.radius,this.space*_roundIndex,roundPointCount)}var randIndex=Math.min(Math.max(Math.floor(Math.random()*_curRoundPositions.length),_curRoundPositions.length-1),0);var pos=_curRoundPositions.splice(randIndex,1)[0];if(_quaternionForRotate){_vector3Tmp.set(pos.x,pos.y,pos.z);_vector3Tmp.applyQuaternion(_quaternionForRotate);pos.x=_vector3Tmp.x;pos.y=_vector3Tmp.y;pos.z=_vector3Tmp.z}return pos};function calcuRadius(maxCount,space,fovRad){var roundCnt=Math.ceil(Math.pow(maxCount/FloorPI+0.25,0.5)-0.5);var faceRadius=space*roundCnt;var radius=faceRadius/(fovRad/2);return radius}function createRoundPositions(R,r,splitCount){var alphaUnit=Math.PI*2/splitCount;var i;var alpha=0;for(i=0;i<splitCount;i++){_curRoundPositions.push({x:r*Math.cos(alpha),y:r*Math.sin(alpha),z:Math.pow(R*R-r*r,0.5)});alpha+=alphaUnit}}};EG3.GridSpherePositionDistribution=function(gridWidth,center,surfaceCenter){this.gridWidth=gridWidth;this.center=new THREE.Vector3(center.x,center.y,center.z);this.surfaceCenter=new THREE.Vector3(surfaceCenter.x,surfaceCenter.y,surfaceCenter.z);this.radius=this.surfaceCenter.clone().sub(center).length();var _gridWidth=this.gridWidth;var _center=this.center;var _gridCellCount;var _curRoundGrids=[];var _quaternionForRotate=new THREE.Quaternion();var _angleStep;var _angleX,_angleY;var _eulerTmp=new THREE.Euler(0,0,0,"YXZ");var _centerVector;this.reset=function(){_gridCellCount=0;_curRoundGrids.splice(0,_curRoundGrids.length);_curRoundGrids.push(this.surfaceCenter);_angleStep=this.gridWidth/this.radius;_angleX=0;_angleY=0;var vZ=new THREE.Vector3(0,0,1);var axisUnitVector=this.surfaceCenter.clone().sub(this.center).normalize();var angle=0;if(!axisUnitVector.equals(vZ)){var triangle=new THREE.Triangle(new THREE.Vector3(0,0,0),vZ,axisUnitVector);var vNormal=triangle.normal();angle=Math.acos(vZ.dot(axisUnitVector));_quaternionForRotate.setFromAxisAngle(vNormal,angle)}else{_quaternionForRotate=null}_centerVector=new THREE.Vector3(0,0,this.radius)};this.reset();this.nextPosition=function(){var x,y,z;if(_curRoundGrids.length==0){_gridCellCount+=2;createRoundPositions(_gridCellCount,this.gridWidth)}var randIndex=0;var pos=_curRoundGrids.splice(randIndex,1)[0];return pos};function createRoundPositions(d,angleStep){_angleY+=_angleStep;_angleX+=_angleStep;_curRoundGrids.push(positionRotateFromCenterVector());for(i=1;i<=d;i++){_angleX-=_angleStep;_curRoundGrids.push(positionRotateFromCenterVector())}for(i=1;i<=d;i++){_angleY-=_angleStep;_curRoundGrids.push(positionRotateFromCenterVector())}for(i=1;i<=d;i++){_angleX+=_angleStep;_curRoundGrids.push(positionRotateFromCenterVector())}for(i=1;i<=d;i++){_angleY+=_angleStep;if(i!=d){_curRoundGrids.push(positionRotateFromCenterVector())}}}function positionRotateFromCenterVector(){_eulerTmp.set(_angleX,_angleY,0,"YXZ");var vectorTmp=_centerVector.clone().applyEuler(_eulerTmp);if(_quaternionForRotate){vectorTmp.applyQuaternion(_quaternionForRotate)}return vectorTmp.add(_center)}function rotateLeft(vector,angle){var quaternionForRotate=new THREE.Quaternion();quaternionForRotate.setFromAxisAngle(new THREE.Vector3(1,0,0),-_angleStep)}function vectorToPosition(vector){return new THREE.Vector3(vector.x+_center.x,vector.y+_center.y,vector.z+_center.z)}};EG3.NetworkGraph=function(args){this.scene=args.scene;this.center=new THREE.Vector3(0,0,0);this.gridWidth=100;this.gridRadianMax=Math.PI/2;this.lineColor=1052927;this.lineArrowLength=100;this.lineArrowWidth=15;this.pointColor=16603738;this.pointRadius=8;this.pointRadiusMax=this.pointRadius*10;this.isDrawLines=true;this.isDrawNeighbours=true;if(args.center!=undefined){this.center=args.center}if(args.gridWidth!=undefined){this.gridWidth=args.gridWidth}if(args.gridRadianMax!=undefined){this.gridRadianMax=args.gridRadianMax}if(args.lineColor!=undefined){this.lineColor=args.lineColor}if(args.lineArrowLength!=undefined){this.lineArrowLength=args.lineArrowLength}if(args.lineArrowWidth!=undefined){this.lineArrowWidth=args.lineArrowWidth}if(args.pointColor!=undefined){this.pointColor=args.pointColor}if(args.pointRadius!=undefined){this.pointRadius=args.pointRadius}if(args.isDrawLines!=undefined){this.isDrawLines=args.isDrawLines}if(args.isDrawNeighbours!=undefined){this.isDrawNeighbours=args.isDrawNeighbours}var _callbackAfterPointAdded=args.callbackAfterPointAdded;this.o3dPoints=undefined;this.o3dLines=undefined;var _center=this.center;var _gridWidth=this.gridWidth;var _gridRadianMax=this.gridRadianMax;var _lineColor=this.lineColor;var _lineArrowLength=this.lineArrowLength;var _lineArrowWidth=this.lineArrowWidth;var _pointColor=this.pointColor;var _pointRadius=this.pointRadius;var _pointRadiusMax=this.pointRadiusMax;var _isDrawLines=this.isDrawLines;var _isDrawNeighbours=this.isDrawNeighbours;var _ballMap=new EG3.Map();var _o3dContainer;var _o3dPoints;var _o3dLines;var _geomLines;var _childrenFocusPosition;this.clear=function(){_ballMap.clear();if(_o3dContainer){this.scene.remove(_o3dContainer)}delete _o3dPoints;delete _o3dLines;delete _o3dContainer};this.reloadGraphNodes=function(graphNodes){this.clear();_o3dPoints=new THREE.Object3D();_o3dLines=new THREE.Object3D();_geomLines=new THREE.Geometry();this.o3dPoints=_o3dPoints;this.o3dLines=_o3dLines;_o3dContainer=new THREE.Object3D();_o3dContainer.add(_o3dPoints);_o3dContainer.add(_o3dLines);this.scene.add(_o3dContainer);var gridSphereCenter=new THREE.Vector3(this.center.x,this.center.y,this.center.z-800);_childrenFocusPosition=new THREE.Vector3(gridSphereCenter.x,gridSphereCenter.y,gridSphereCenter.z-500);makeGraphNodesNoRecursion(graphNodes,gridSphereCenter)};function makeGridSphereRadius(maxCount,gridWidth,gridRadianMax){return gridWidth*Math.pow(maxCount,0.5)/gridRadianMax}function getBallRadiusOfGraph(childrenCount,pointRadius){if(childrenCount==0){return pointRadius}else{return pointRadius*Math.log(childrenCount)*2}}function addLine(startPoint,endPoint){if(!_isDrawLines){return}var p2=endPoint.clone();var lineVec=p2.sub(startPoint);var lineLen=lineVec.length();var headLength=_lineArrowLength;var headWidth=_lineArrowWidth;var obj3Line=new THREE.ArrowHelper(lineVec.normalize(),startPoint,lineLen,_lineColor,headLength,headWidth);_o3dLines.add(obj3Line)}function makeGraphNodesNoRecursion(graphNodes,gridSphereCenter){var graphNodesPackageBuffer=[];var graphNodesPackageBuffer2=[];var allGraphNodesMap=new EG3.Map();var unrenderedGraphNodesMap=new EG3.Map();var renderedNodePosMap=new EG3.Map();var nodesPackage={isFakeParent:true,parentPos:gridSphereCenter,children:[]};graphNodes.forEach(function(graphNode){if(graphNode.vid!=undefined&&graphNode.vid.length>0){unrenderedGraphNodesMap.set(graphNode.vid,graphNode);allGraphNodesMap.set(graphNode.vid,graphNode);if(graphNode.parents.length==0){nodesPackage.children.unshift(graphNode)}}});if(nodesPackage.children.length==0){graphNodes.sort(function(v1,v2){return v2.children.length-v1.children.length});nodesPackage.children=graphNodes.splice(0,1000)}graphNodesPackageBuffer.unshift(nodesPackage);var newGridSphereCenter;while(graphNodesPackageBuffer.length!=0){var nodesPackage;while((nodesPackage=graphNodesPackageBuffer.pop())){var posDist;newGridSphereCenter=nodesPackage.parentPos;var newGridSphereRadius=Math.max(makeGridSphereRadius(nodesPackage.children.length,_gridWidth,_gridRadianMax),_gridWidth*2);var newGridSphereSurfaceCenterDir=newGridSphereCenter.clone().sub(_childrenFocusPosition).normalize();var newGridSphereSurfaceCenter=newGridSphereSurfaceCenterDir.multiplyScalar(newGridSphereRadius).add(newGridSphereCenter);posDist=new EG3.GridSpherePositionDistribution(_gridWidth,newGridSphereCenter,newGridSphereSurfaceCenter);var graph;while((graph=nodesPackage.children.pop())){if(unrenderedGraphNodesMap.get(graph.vid)==undefined){continue}unrenderedGraphNodesMap.del(graph.vid);var thisPos=renderedNodePosMap.get(graph.vid);if(thisPos==undefined){thisPos=posDist.nextPosition();renderedNodePosMap.set(graph.vid,thisPos);var ballR=getBallRadiusOfGraph(graph.children.length,_pointRadius);var geom=new THREE.SphereGeometry(ballR);var ball=new THREE.Mesh(geom,new THREE.MeshBasicMaterial({color:_pointColor}));ball.position.set(thisPos.x,thisPos.y,thisPos.z);_o3dPoints.add(ball);if(_callbackAfterPointAdded){_callbackAfterPointAdded(ball,graph)}}if(!nodesPackage.isFakeParent){addLine(newGridSphereCenter,thisPos)}if(graph.children.length>0){var newNodesPackage={parentPos:thisPos.clone(),children:[]};graph.children.forEach(function(childId){var node=allGraphNodesMap.get(childId);if(node!=undefined){newNodesPackage.children.unshift(node)}});graphNodesPackageBuffer2.unshift(newNodesPackage)}}}graphNodesPackageBuffer=graphNodesPackageBuffer2.splice(0,graphNodesPackageBuffer2.length)}if(unrenderedGraphNodesMap.size()>0){var newGraphNodes=[];unrenderedGraphNodesMap.forEach(function(node){newGraphNodes.push(node)});makeGraphNodesNoRecursion(newGraphNodes,newGridSphereCenter)}}};